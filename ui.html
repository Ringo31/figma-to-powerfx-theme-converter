<html>
<head>
  <meta charset="utf-8">
  <title>Figma to PowerFX Theme Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

  <div class="flex bg-gray-100 h-dvh font-mono text-gray-700">
    
    <div class="flex-none w-1/3 bg-gray-50 border-r border-gray-300 p-4 space-y-4">

      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-700" for="variable-collections">Collection</label>
        <select class="flex-1 mt-1 rounded-md border border-purple-300 focus:outline-purple-700 shadow-sm sm:text-sm" id="variable-collections" onchange="selectHandler()"></select>
      </div>

      <!-- <div class="flex flex-col">
        <div class="flex flex-row">
          <label class="flex-1" for="switch-checkbox" class="text-sm font-medium">Include Switch</label>
          <input class="mx-2" id="switch-checkbox" type="checkbox" onclick="checkboxHandler()">
        </div>
        <div class="flex-1" id="variable-container" class="invisible" >
          <input id="variable-name" class="w-full px-1 mt-1 rounded-md border border-purple-300 focus:outline-purple-700 shadow-sm sm:text-sm" type="text" spellcheck="false" value="varMode" onchange="inputHandler()">
        </div>s
      </div> -->

      <!-- TODO table qui contient les éléments de premier niveau de la collection sélectionnée. Une colonne pour le nom de l'element, une autre un checkbox qui indique si l'element est sélectionné -->
      <table id="token-table"></table>

      

    </div>
    
    <div class="flex-1 flex flex-col gap-4 p-4 col-span-2">
      <div class="flex-1 flex flex-col">
        <label for="output" class="block text-sm font-medium">Query output</label>
        <textarea class="flex-1 mt-1 p-2 w-full rounded-md border border-purple-300 focus:outline-purple-700 shadow-sm text-xs resize-none" wrap="off" id="output" readonly></textarea>  
      </div>
      
      <!-- <button onclick="copyToClipboard()" class="self-end bg-purple-500 hover:bg-purple-600 active:bg-purple-700  rounded-md text-gray-100 w-32">Copier</button> -->
    </div>
    
  </div>
  
  

  <script>

    function checkboxHandler() {
      // Get an array of booleans indicating whether each checkbox is checked or not
      const tokenParams = Array.prototype.map.call(document.getElementById('token-table').querySelectorAll("input[type=checkbox]"), checkbox => { return {tokenName: checkbox.id, groupByModes: checkbox.checked} });

      // Get the selected collection
      const collectionId = document.getElementById('variable-collections').value

      // Send the message to the main script
      parent.postMessage({ pluginMessage: { type : 'requestDisplay', collectionId : collectionId, tokenParams: tokenParams } }, '*');  
    }

    function selectHandler() {

      // Get the selected collection
      const collectionId = document.getElementById('variable-collections').value

      // Send the message to the main script
      parent.postMessage({ pluginMessage: { type : 'requestCollection', collectionId: collectionId } }, '*');
    }
   

    /* function inputHandler() {
      const varName = document.getElementById('variable-name').value;
      const selectedCollectionId = document.getElementById('variable-collections').value;
      parent.postMessage({ pluginMessage: { type: 'convert-variables', collectionId: selectedCollectionId, groupBy: "mode", varName: varName } }, '*')
    } */


    /**
     * Handler for messages sent from the main script to the UI script.
     * @param {MessageEvent} event - The message event containing the plugin message.
     */
    onmessage = (event) => {
      const message = event.data.pluginMessage;

      if (message.type === 'sendCollectionsList') {

        // Remplir le menu déroulant avec les collections
        const selectElement = document.getElementById('variable-collections');
        selectElement.innerHTML = ''; // Réinitialiser les options

        message.collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.setAttribute('data-modesLenght', collection.modesLenght);
          option.textContent = collection.name;
          selectElement.appendChild(option);
        });

        // Générer le code de la première collection par défaut si elle existe
        if (message.collections.length > 0) {
          const firstCollectionId = message.collections[0].id;
          //parent.postMessage({ pluginMessage: { type: 'convert-variables', collectionId: firstCollectionId, groupBy: "variant" } }, '*');
          parent.postMessage({ pluginMessage: { type : 'requestCollection', collectionId: firstCollectionId } }, '*');
        }
      }

      if (message.type === 'sendTokensList') {
        // Remplir le table avec la liste des tokens
        const tableBody = document.getElementById('token-table');

        // Clear the table body
        tableBody.innerHTML = '';

        // Create a row for each token
        message.tokensList.forEach(token => {
          
          // Create a row
          const row = document.createElement('tr');

          // Create a cell for the token name
          const nameCell = document.createElement('td');
          nameCell.innerText = token;
          row.appendChild(nameCell);

          // Create a cell for the checkbox
          const valueCell = document.createElement('td');
          valueCell.innerHTML = `<input type="checkbox" id="${token}" name="switch" class="switch" onclick="checkboxHandler()" /><label for="${token}" class="switch-label"></label>`
          row.appendChild(valueCell);

          // Add the row to the table
          tableBody.appendChild(row);
        });

        // Initialize the tokenParams array
        //const tokenParams = new Array(message.tokensList.length).fill(false);
        const tokenParams = message.tokensList.map(token => ({ tokenName: token, groupByModes: false }));
        
        // Get the selected collection
        const collectionId = document.getElementById('variable-collections').value

        // Send the message to the main script
        parent.postMessage({ pluginMessage: { type : 'requestDisplay', collectionId : collectionId, tokenParams: tokenParams } }, '*');
      }

      if (message.type === 'sendDisplay') {
        document.getElementById('output').textContent = message.displayTree;
      }
    }
  </script>
</body>
</html>